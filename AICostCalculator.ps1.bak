#!/usr/bin/env pwsh
# Simple, robust AI Cost Calculator (clean rebuild)
# - accepts decimal inputs
# - provides menu modes for today's input
# - computes current and today hourly rates, projections, recommendation, ASCII graph

function Parse-HHMM($s) {
    try { return [datetime]::ParseExact($s, 'HH:mm', $null) }
    catch { return $null }
}

function ToHours($dt) { return $dt.Hour + ($dt.Minute / 60.0) }

[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

# US federal holidays helper (observed dates)
function Get-USFederalHolidays($year) {
    $h = @()
    # New Year's Day
    $h += (Get-Date -Year $year -Month 1 -Day 1)
    # Martin Luther King Jr. Day: third Monday in January
    $h += (Get-NthWeekdayOfMonth $year 1 'Monday' 3)
    # Presidents' Day: third Monday in February
    $h += (Get-NthWeekdayOfMonth $year 2 'Monday' 3)
    # Memorial Day: last Monday in May
    $h += (Get-LastWeekdayOfMonth $year 5 'Monday')
    # Juneteenth: June 19
    $h += (Get-Date -Year $year -Month 6 -Day 19)
    # Independence Day: July 4
    $h += (Get-Date -Year $year -Month 7 -Day 4)
    # Labor Day: first Monday in September
    $h += (Get-NthWeekdayOfMonth $year 9 'Monday' 1)
    # Columbus Day / Indigenous Peoples' Day: second Monday in October
    $h += (Get-NthWeekdayOfMonth $year 10 'Monday' 2)
    # Veterans Day: Nov 11
    $h += (Get-Date -Year $year -Month 11 -Day 11)
    # Thanksgiving: fourth Thursday in November
    $h += (Get-NthWeekdayOfMonth $year 11 'Thursday' 4)
    # Christmas: Dec 25
    $h += (Get-Date -Year $year -Month 12 -Day 25)

    # Apply observed rule: if holiday falls on weekend, adjust
    $observed = @()
    foreach ($dt in $h) {
        if ($dt.DayOfWeek -eq 'Saturday') { $observed += $dt.AddDays(-1).Date }
        elseif ($dt.DayOfWeek -eq 'Sunday') { $observed += $dt.AddDays(1).Date }
        else { $observed += $dt.Date }
    }
    return $observed | Sort-Object
}

# Config
$BasePlanPrice = 10.00
$OveragePricePerRequest = 0.04
$MonthlyBudget = 20.00
$HoursPerWorkday = 8.0
$DefaultBasePlanRequests = 300

# Optional higher tier: 1500 requests for $39.99/month
$Plan1500Requests = 1500
$Plan1500Price = 39.99
# Threshold where switching to 1500-plan usually makes sense
$Plan1500Threshold = 1250

# Optional next tier (example): large/enterprise plan you might buy preemptively
$PlanNextRequests = 5000
$PlanNextPrice = 500.00
$PlanNextName = 'NextTier'

# Test-mode: allow automated runs by setting env vars early (overrides prompts)
if ($env:AI_TEST -eq '1') {
    if ($env:AI_START) { $startDt = Parse-HHMM $env:AI_START }
    if ($env:AI_CURRENT) {
        if ([string]::IsNullOrWhiteSpace($env:AI_CURRENT)) { $currentDt = Get-Date } else { $currentDt = Parse-HHMM $env:AI_CURRENT }
    }
    if ($env:AI_REQUESTS_MONTH) { $requestsMonth = [double]$env:AI_REQUESTS_MONTH }
    if ($env:AI_DATE) { try { $givenDate = [datetime]::ParseExact($env:AI_DATE,'yyyy-MM-dd',$null) } catch { Write-Host 'Invalid date format in AI_DATE'; exit 1 } }
    if ($env:AI_BASEPLAN) { $bpv=0; if (-not [int]::TryParse($env:AI_BASEPLAN,[ref]$bpv)) { Write-Host 'Invalid AI_BASEPLAN' ; exit 1 } ; $basePlanRequests=[int]$bpv }
    if ($env:AI_MODE) { $mode = $env:AI_MODE }
    if ($env:AI_TODAY_CURRENT) { $envToday = $env:AI_TODAY_CURRENT } else { $envToday = $null }
}

if (-not $startDt) {
    Write-Host "Start time (HH:mm):" -NoNewline; $startInput = Read-Host
    $startDt = Parse-HHMM $startInput
    if (-not $startDt) { Write-Host 'Invalid start time'; exit 1 }
} else {
    Write-Host "Start time (HH:mm): $($startDt.ToString('HH:mm')) (from AI_TEST)"
}

if (-not $currentDt) {
    Write-Host "Current clock time (HH:mm) or leave blank for system time:" -NoNewline; $currentTimeInput = Read-Host
    if ([string]::IsNullOrWhiteSpace($currentTimeInput)) {
        $currentDt = Get-Date
    } else {
        $currentDt = Parse-HHMM $currentTimeInput
        if (-not $currentDt) { Write-Host 'Invalid current time'; exit 1 }
    }
} else {
    Write-Host "Current clock time: $($currentDt.ToString('HH:mm')) (from AI_TEST)"
}

if (-not ($requestsMonth -ne $null -and $requestsMonth -is [double])) {
    Write-Host "Requests month-to-date (number, decimals allowed):" -NoNewline; $requestsMonthInput = Read-Host
    $requestsMonthVal = 0.0
    if (-not [double]::TryParse($requestsMonthInput, [ref]$requestsMonthVal)) { Write-Host 'Invalid number for requests month-to-date'; exit 1 }
    $requestsMonth = [double]$requestsMonthVal
} else {
    Write-Host "Requests month-to-date: $([math]::Round($requestsMonth,2)) (from AI_TEST)"
}

if (-not $givenDate) {
    Write-Host "Full date (YYYY-MM-DD):" -NoNewline; $dateInput = Read-Host
    try { $givenDate = [datetime]::ParseExact($dateInput,'yyyy-MM-dd',$null) } catch { Write-Host 'Invalid date format'; exit 1 }
} else {
    Write-Host "Full date: $($givenDate.ToString('yyyy-MM-dd')) (from AI_TEST)"
}

if (-not $basePlanRequests) {
    Write-Host "Base plan requests for this month (leave blank for $DefaultBasePlanRequests):" -NoNewline; $bpi = Read-Host
    if ([string]::IsNullOrWhiteSpace($bpi)) { $basePlanRequests = $DefaultBasePlanRequests } else { $bpv=0; if (-not [int]::TryParse($bpi,[ref]$bpv)) { Write-Host 'Invalid integer for base plan'; exit 1 } ; $basePlanRequests=[int]$bpv }
} else {
    Write-Host "Base plan requests: $basePlanRequests (from AI_TEST)"
}



# Compute workdays in month (simple: exclude weekends only)
function Get-WorkdaysInMonth($year,$month) {
    $cnt=0; $days=[datetime]::DaysInMonth($year,$month)
    for ($d=1;$d -le $days;$d++) { $dt=Get-Date -Year $year -Month $month -Day $d; if ($dt.DayOfWeek -ne 'Saturday' -and $dt.DayOfWeek -ne 'Sunday') { $cnt++ } }
    return $cnt
}

$year=$givenDate.Year; $month=$givenDate.Month; $dayOfMonth=$givenDate.Day
$workdaysInMonth = Get-WorkdaysInMonth $year $month

# normalize start/current to givenDate
$startRef = Get-Date -Year $givenDate.Year -Month $givenDate.Month -Day $givenDate.Day -Hour $startDt.Hour -Minute $startDt.Minute -Second 0
$currentRef = Get-Date -Year $givenDate.Year -Month $givenDate.Month -Day $givenDate.Day -Hour $currentDt.Hour -Minute $currentDt.Minute -Second 0
$curH = ToHours($currentRef)
$startH = ToHours($startRef)
$elapsedSoFar = [math]::Max(0.0, $curH - $startH)
$hoursRemainingToday = [math]::Max(0.0, $HoursPerWorkday - $elapsedSoFar)

# initialize today's counters; detailed input menu appears later in the script
# menu
Write-Host ""; Write-Host "Select input mode for today's usage:" -ForegroundColor Cyan
Write-Host "  1) Month-to-date only"; Write-Host "  2) Provide month-to-date at start of day"; Write-Host "  3) Provide today's current count"
if (-not $mode) {
    $mode = Read-Host "Enter 1/2/3 (default 1)"
    if ([string]::IsNullOrWhiteSpace($mode)) { $mode = '1' }
} else {
    Write-Host "Enter 1/2/3 (default 1): $mode (from AI_TEST)"
}

$requestsToday = 0.0; $todayHourlyRate = $null; $projectedMonthlyFromTodayRate = $null
if ($mode -eq '2') {
    if ($env:AI_MONTHSTART) {
        $mv = [double]$env:AI_MONTHSTART
        $requestsToday = [math]::Max(0.0, $requestsMonth - $mv)
        Write-Host "Month-to-date at start of day (number): $mv (from AI_TEST)"
    } else {
        $ms = Read-Host 'Month-to-date at start of day (number)'
        $mv=0.0; if (-not [double]::TryParse($ms,[ref]$mv)) { Write-Host 'Invalid number' ; exit 1 }
        $requestsToday = [math]::Max(0.0, $requestsMonth - $mv)
    }
} elseif ($mode -eq '3') {
    if ($envToday) {
        $cv=[double]$envToday
        Write-Host "Today's current count (number): $cv (from AI_TEST)"
        $requestsToday = [math]::Max(0.0, $cv - $requestsMonth)
    } else {
        $cur = Read-Host "Today's current count (number)"
        $cv=0.0; if (-not [double]::TryParse($cur,[ref]$cv)) { Write-Host 'Invalid number' ; exit 1 }
        $requestsToday = [math]::Max(0.0, $cv - $requestsMonth)
    }
    if ($elapsedSoFar -gt 0) { $todayHourlyRate = $requestsToday / $elapsedSoFar; $projectedMonthlyFromTodayRate = $todayHourlyRate * $HoursPerWorkday * $workdaysInMonth }
}

# calculations
$workedFullDays = [math]::Max(0, ([math]::Floor(($dayOfMonth-1)/1))) # simple: days before today
$workedHoursSoFar = ($workedFullDays * $HoursPerWorkday) + $elapsedSoFar
if ($workedHoursSoFar -le 0) { $currentHourlyRate = 0 } else { $currentHourlyRate = $requestsMonth / $workedHoursSoFar }
$projectedMonthlyFromCurrentRate = $currentHourlyRate * $HoursPerWorkday * $workdaysInMonth

$allowedOverage = [math]::Max(0.0, $MonthlyBudget - $BasePlanPrice)
$allowedExtraRequests = [math]::Floor($allowedOverage / $OveragePricePerRequest)
$monthlyTargetRequests = $basePlanRequests + $allowedExtraRequests
$remainingMonthlyRequests = [math]::Max(0.0, $monthlyTargetRequests - $requestsMonth)

$daysLeftWorking = [math]::Max(0, $workdaysInMonth - [math]::Floor($dayOfMonth))
if ($daysLeftWorking -gt 0) { $projectedDailyNeeded = [math]::Ceiling($remainingMonthlyRequests / $daysLeftWorking) } else { $projectedDailyNeeded = $remainingMonthlyRequests }

$todayRemainingRequests = [math]::Max(0.0, $projectedDailyNeeded - $requestsToday)
if ($hoursRemainingToday -gt 0) { $projectedHourlyNeededToday = [math]::Ceiling($todayRemainingRequests / $hoursRemainingToday) } else { $projectedHourlyNeededToday = 0 }

# projected costs
if ($projectedMonthlyFromCurrentRate -le $basePlanRequests) {
    $projectedCostFromCurrentRate = $BasePlanPrice
} else {
    $cand = $BasePlanPrice + (($projectedMonthlyFromCurrentRate - $basePlanRequests) * $OveragePricePerRequest)
    if ($projectedMonthlyFromCurrentRate -ge $Plan1500Threshold) { $projectedCostFromCurrentRate = [math]::Min($cand, $Plan1500Price) } else { $projectedCostFromCurrentRate = $cand }
}
if ($projectedMonthlyFromTodayRate -ne $null) {
    if ($projectedMonthlyFromTodayRate -le $basePlanRequests) {
        $projectedCostFromTodayRate = $BasePlanPrice
    } else {
        $candT = $BasePlanPrice + (($projectedMonthlyFromTodayRate - $basePlanRequests) * $OveragePricePerRequest)
        if ($projectedMonthlyFromTodayRate -ge $Plan1500Threshold) { $projectedCostFromTodayRate = [math]::Min($candT, $Plan1500Price) } else { $projectedCostFromTodayRate = $candT }
    }
} else { $projectedCostFromTodayRate = $null }

# recommendation
$remainingWorkingHours = ($daysLeftWorking * $HoursPerWorkday) + $hoursRemainingToday
if ($remainingWorkingHours -le 0) { $allowedHourlyRateForRemaining = 0 } else { $allowedHourlyRateForRemaining = $remainingMonthlyRequests / $remainingWorkingHours }

# small helper for bars
function Get-Bar([double]$val, [double]$max) {
    $width = 40
    if ($max -le 0 -or [double]::IsNaN($max) -or [double]::IsInfinity($max)) { $max = 1.0 }
    $ratio = 0.0
    if ($val -gt 0) { $ratio = $val / $max }
    if ($ratio -lt 0) { $ratio = 0 }
    if ($ratio -gt 1) { $ratio = 1 }
    $len = [int]([math]::Round($ratio * $width))
    return ('=' * $len) + (' ' * ($width - $len))
}

# graph max
if ($todayHourlyRate -ne $null) { $todayVal = [double]$todayHourlyRate } else { $todayVal = 0.0 }
$graphMax = [math]::Max(1.0, [math]::Max($allowedHourlyRateForRemaining, [math]::Max($currentHourlyRate, $todayVal)))

# output
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "==== Forecast Summary ====" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "Given date: $($givenDate.ToString('yyyy-MM-dd'))" -ForegroundColor Yellow
Write-Host "Start: $($startDt.ToString('HH:mm'))   Current: $($currentRef.ToString('HH:mm'))   Elapsed hrs: $([math]::Round($elapsedSoFar,2))" -ForegroundColor White
Write-Host "Requests month-to-date: $([math]::Round($requestsMonth,2))" -ForegroundColor Green
Write-Host "Requests today (computed): $([math]::Round($requestsToday,2))" -ForegroundColor Green
Write-Host "-- Projections --" -ForegroundColor DarkCyan
Write-Host "Current hourly rate (req/hr): $([math]::Round($currentHourlyRate,2))" -ForegroundColor Yellow
Write-Host "Projected monthly (from current): $([math]::Round($projectedMonthlyFromCurrentRate,0))" -ForegroundColor Yellow
if ($projectedMonthlyFromTodayRate -ne $null) { Write-Host "Today hourly rate (req/hr): $([math]::Round($todayHourlyRate,2))" -ForegroundColor Cyan; Write-Host "Projected monthly (from today): $([math]::Round($projectedMonthlyFromTodayRate,0))" -ForegroundColor Cyan }
Write-Host "Recommendation: keep average <= $([math]::Round($allowedHourlyRateForRemaining,2)) req/hr for remaining hours" -ForegroundColor Green

Write-Host ""; Write-Host "-- Rate Comparison (req/hr) --" -ForegroundColor DarkCyan
Write-Host "Legend: Allowed = allowed avg for remaining hours; Current = month avg; Today = today's run-rate" -ForegroundColor White
$allowedLine = ('Allowed  : [{0}] {1:N2} req/hr' -f (Get-Bar $allowedHourlyRateForRemaining $graphMax), $allowedHourlyRateForRemaining)
Write-Host $allowedLine -ForegroundColor Green
$currentLine = ('Current  : [{0}] {1:N2} req/hr' -f (Get-Bar $currentHourlyRate $graphMax), $currentHourlyRate)
Write-Host $currentLine -ForegroundColor Yellow
if ($todayHourlyRate -ne $null) {
    $col='Cyan'; if ($todayHourlyRate -gt $allowedHourlyRateForRemaining) { $col='Red' }
    $todayLine = ('Today    : [{0}] {1:N2} req/hr' -f (Get-Bar $todayHourlyRate $graphMax), $todayHourlyRate)
    Write-Host $todayLine -ForegroundColor $col
}
Write-Host "====================================" -ForegroundColor Cyan

Write-Host "Done." -ForegroundColor Cyan
# forecast_full.ps1
# Prompts:
#  - Start time (HH:mm)
#  - Current clock time (HH:mm) (or leave blank to use system current time)
#  - Requests so far today (number, decimals allowed)
#  - Requests month-to-date (number, decimals allowed)
#  - Full date (YYYY-MM-DD)
$cmpCount = 0
Write-Host "-- Comparisons & Alerts --" -ForegroundColor DarkMagenta
if ($projectedMonthlyFromTodayRate -ne $null) {
    $diff = $projectedMonthlyFromTodayRate - $monthlyTargetRequests
    if ($diff -gt 0) { $m = ("ALERT: Today's-rate projection exceeds monthly target by {0:N0} requests" -f $diff); Write-Host $m -ForegroundColor Red; $cmpCount++ } else { $m = ("OK: Today's-rate projection is {0:N0} requests below monthly target" -f ([math]::Abs($diff))); Write-Host $m -ForegroundColor Green }
}

$diffCurrent = $projectedMonthlyFromCurrentRate - $monthlyTargetRequests
if ($diffCurrent -gt 0) { $m = ("WARN: Current-rate projection exceeds monthly target by {0:N0} requests" -f $diffCurrent); Write-Host $m -ForegroundColor Yellow; $cmpCount++ } else { $m = ("OK: Current-rate projection is {0:N0} requests below monthly target" -f ([math]::Abs($diffCurrent))); Write-Host $m -ForegroundColor Green }

if ($projectedCostFromTodayRate -ne $null) {
    $costDiff = $projectedCostFromTodayRate - $MonthlyBudget
    if ($costDiff -gt 0) { $m = ("ALERT: Projected monthly cost (today's rate) exceeds budget by {0:N2}" -f $costDiff); Write-Host $m -ForegroundColor Red; $cmpCount++ } else { $m = ("OK: Projected monthly cost (today's rate) is {0:N2} below budget" -f ([math]::Abs($costDiff))); Write-Host $m -ForegroundColor Green }
}

$costDiffCur = $projectedCostFromCurrentRate - $MonthlyBudget
if ($costDiffCur -gt 0) { $m = ("WARN: Projected monthly cost (current rate) exceeds budget by {0:N2}" -f $costDiffCur); Write-Host $m -ForegroundColor Yellow; $cmpCount++ } else { $m = ("OK: Projected monthly cost (current rate) is {0:N2} below budget" -f ([math]::Abs($costDiffCur))); Write-Host $m -ForegroundColor Green }

if ($cmpCount -eq 0) { Write-Host "No alerts - projections are within targets/budget." -ForegroundColor Cyan }

# Explanation: why Today and Current projections can differ
Write-Host "" -ForegroundColor White
Write-Host "-- Why Today vs Current may differ --" -ForegroundColor DarkMagenta
Write-Host "Today is a short-term run-rate (requests today / elapsed hours)." -ForegroundColor White
Write-Host "Current is the month-to-date average (total requestsMonth / hours worked so far)." -ForegroundColor White
Write-Host "Consequences:" -ForegroundColor Yellow
Write-Host " - A high burst today can make the Today-based projection exceed the monthly target even if the historical Current rate remains below it." -ForegroundColor Yellow
Write-Host " - The Recommendation (Allowed) is computed from remaining requests divided by remaining hours — it's the average rate you must hold from now on to hit the monthly target." -ForegroundColor Yellow
Write-Host " - Use Today for immediate throttling decisions; use Current to understand the overall trend." -ForegroundColor Yellow

# Recommendation: compute allowed average hourly rate for remaining work hours to stay within monthly target
$remainingWorkingHours = ($daysLeftWorking * $HoursPerWorkday) + $hoursRemainingToday
if ($remainingWorkingHours -le 0) { $allowedHourlyRateForRemaining = 0 } else { $allowedHourlyRateForRemaining = $remainingMonthlyRequests / $remainingWorkingHours }
$allowedDailyEquivalent = $allowedHourlyRateForRemaining * $HoursPerWorkday

# Show recommendation and color it red if current hourly rate or today's hourly rate exceed allowable
$recColor = 'Green'
if ($currentHourlyRate -gt $allowedHourlyRateForRemaining) { $recColor = 'Red' }
if ($todayHourlyRate -ne $null -and $todayHourlyRate -gt $allowedHourlyRateForRemaining) { $recColor = 'Red' }
Write-Host ("Recommendation: To stay within monthly target, average ≤ {0:N2} req/hr for remaining work hours (~ {1:N2} req/day)" -f $allowedHourlyRateForRemaining, $allowedDailyEquivalent) -ForegroundColor $recColor

# Per-hour throttle recommendation for the remainder of today
if ($hoursRemainingToday -gt 0) {
    $allowedHourlyToday = $remainingMonthlyRequests / $hoursRemainingToday
    # Keep a conservative suggestion: min of allowedHourlyRateForRemaining and allowedHourlyToday
    $throttleRec = [math]::Min($allowedHourlyRateForRemaining, $allowedHourlyToday)
    $throttleColor = 'Green'
    if ($todayHourlyRate -ne $null -and $throttleRec -lt $todayHourlyRate) { $throttleColor = 'Red' }
    # If the throttle recommendation is effectively the same as the overall allowed hourly rate, skip duplicate line
    if ([math]::Abs($throttleRec - $allowedHourlyRateForRemaining) -ge 0.01) {
        Write-Host ("Throttle recommendation (remainder of today): limit to ≤ {0:N2} req/hr" -f $throttleRec) -ForegroundColor $throttleColor
    }
}

# Simple ASCII bar graph comparing allowed vs current vs today's hourly rates
if ($todayHourlyRate -ne $null) { $todayRateVal = $todayHourlyRate } else { $todayRateVal = 0.0 }
# Nested Max (PowerShell/.NET Math.Max supports two args only) and guard against non-finite values
$graphMax = [math]::Max([math]::Max([math]::Max($allowedHourlyRateForRemaining, $currentHourlyRate), $todayRateVal), 1.0)
if ([double]::IsInfinity($graphMax) -or [double]::IsNaN($graphMax) -or $graphMax -le 0) { $graphMax = 1.0 }

function Get-Bar([double]$val, [double]$max) {
    $width = 40
    if ([double]::IsInfinity($val) -or [double]::IsNaN($val)) { $val = 0.0 }
    if ([double]::IsInfinity($max) -or [double]::IsNaN($max) -or $max -le 0) { $max = 1.0 }
    $ratio = $val / $max
    if ([double]::IsInfinity($ratio) -or [double]::IsNaN($ratio)) { $ratio = 0.0 }
    $len = [int]([math]::Round($ratio * $width))
    if ($len -lt 0) { $len = 0 }
    if ($len -gt $width) { $len = $width }
    return ('=' * $len) + (' ' * ($width - $len))
}
Write-Host "" -ForegroundColor White
Write-Host "-- Rate Comparison (req/hr) --" -ForegroundColor DarkCyan
Write-Host "Legend:" -ForegroundColor DarkCyan
Write-Host "  - Allowed : avg req/hr you can sustain for all remaining work hours (green)" -ForegroundColor Green
Write-Host "  - Current : month-to-date average req/hr so far (yellow)" -ForegroundColor Yellow
Write-Host "  - Today's  : current day's run-rate (req/hr) - noisy early; turns red if above Allowed" -ForegroundColor Cyan
$allowedLine = ('Allowed  : [{0}] {1:N2} req/hr' -f (Get-Bar $allowedHourlyRateForRemaining $graphMax), $allowedHourlyRateForRemaining)
Write-Host $allowedLine -ForegroundColor Green
$currentLine = ('Current  : [{0}] {1:N2} req/hr' -f (Get-Bar $currentHourlyRate $graphMax), $currentHourlyRate)
Write-Host $currentLine -ForegroundColor Yellow
if ($todayHourlyRate -ne $null) {
    $todayColor = 'Cyan'
    # Use a small tolerance to avoid floating-point rounding hiding slight overruns
    if ($todayHourlyRate -gt ($allowedHourlyRateForRemaining + 0.0001)) { $todayColor = 'Red' }
    $todayLine = ('Today    : [{0}] {1:N2} req/hr' -f (Get-Bar $todayHourlyRate $graphMax), $todayHourlyRate)
    Write-Host $todayLine -ForegroundColor $todayColor
}
Write-Host "====================================" -ForegroundColor Cyan
